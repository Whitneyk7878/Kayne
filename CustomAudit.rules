# EXPIREMENTAL
# PLACE INTO
# /etc/audit/audit.rules
#
#
# Created  : 02/20/2025
#
# Based on rules published here:
#   https://attack.mitre.org/tactics/enterprise/

# Remove any existing rules
-D

# Buffer Size
## Feel free to increase this if the machine panic's
-b 8192

# Failure Mode
## Possible values: 0 (silent), 1 (printk, print a failure message), 2 (panic, halt the system)
-f 1

# Ignore errors
## e.g. caused by users or files not found in the local environment
-i
# NOTES: when auid is set to >=1000 that means it is monitoring for all non root users.
# If you dont have root users you need to change it to auid=0


#//////////////////////////////////////////////////////////////////////////////////////////////////////
# TA0002 EXECUTION
#//////////////////////////////////////////////////////////////////////////////////////////////////////

#///////////////////////////////////////////////////
# T1059 - Command and Scripting Interpreter Execution
#///////////////////////////////////////////////////

# Monitor shell execution
-a always,exit -F arch=b64 -S execve -F path=/bin/sh -F key=TA0002_T1059_shell
-a always,exit -F arch=b64 -S execve -F path=/bin/bash -F key=TA0002_T1059_shell
-a always,exit -F arch=b64 -S execve -F path=/bin/zsh -F key=TA0002_T1059_shell

# Monitor scripting languages
# WILL ONLY TRACK INSTALLATION OR MODIFICATION OF THE BINARY
# BREAK THESE IN YOUR SCRIPT SO THAT THEY CANT USE THEM ANYWAYS
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/python3 -F key=TA0002_T1059_python3
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/python -F key=TA0002_T1059_python
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/node -F key=TA0002_T1059_javascript
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/lua -F key=TA0002_T1059_lua
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/ruby -F key=TA0002_T1059_ruby
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/perl -F key=TA0002_T1059_perl
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/node -F key=TA0002_T1059_nodejs
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/fish -F key=TA0002_T1059_fish

#///////////////////////////////////////////////////
# T1053 - Scheduled Task/Job Executionn
#///////////////////////////////////////////////////

# Monitor 'at' command execution
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/at -F key=TA0002_T1053_at
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/at -F key=TA0002_T1053_at

# Monitor cron job modifications
-w /etc/cron.d/ -p wa -k TA0002_T1053_cron
-w /etc/cron.daily/ -p wa -k TA0002_T1053_cron
-w /etc/cron.hourly/ -p wa -k TA0002_T1053_cron
-w /etc/cron.weekly/ -p wa -k TA0002_T1053_cron
-w /etc/cron.monthly/ -p wa -k TA0002_T1053_cron
-w /etc/crontab -p wa -k TA0002_T1053_cron

# Monitor systemd timer changes
-w /etc/systemd/system/ -p wa -k TA0002_T1053_systemd
-w /usr/lib/systemd/system/ -p wa -k TA0002_T1053_systemd
-w /var/spool/cron/ -p wa -k TA0002_T1053_cron

#///////////////////////////////////////////////////
# T1609 - Container Administration Commands
#///////////////////////////////////////////////////

# Monitor Docker commands
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/docker -F key=TA0002_T1609_docker
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/dockerd -F key=TA0002_T1609_docker
-a always,exit -F arch=b64 -S execve -F path=/usr/local/bin/docker -F key=TA0002_T1609_docker

# Monitor Kubernetes commands
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/kubectl -F key=TA0002_T1609_kubernetes
-a always,exit -F arch=b64 -S execve -F path=/usr/local/bin/kubectl -F key=TA0002_T1609_kubernetes
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/kubeadm -F key=TA0002_T1609_kubernetes
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/kubelet -F key=TA0002_T1609_kubernetes

#///////////////////////////////////////////////////
# T1204  - User Execution
#///////////////////////////////////////////////////

# Monitor all file creations and deletions system-wide
# -w / -p wa -k TA0002_T1072_file_ops

# Monitor all syscalls related to file creation and deletion
# -a always,exit -F arch=b64 -S open,openat,creat,unlink,unlinkat,rename,renameat -F key=TA0002_T1072_file_ops
# -a always,exit -F arch=b32 -S open,openat,creat,unlink,unlinkat,rename,renameat -F key=TA0002_T1072_file_ops

#///////////////////////////////////////////////////
# T1072  - Software Deployement Tools
#///////////////////////////////////////////////////

# Ansible Monitoring
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/ansible -F key=TA0002_T1072_Ansible
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/ansible-playbook -F key=TA0002_T1072_Ansible
-w /etc/ansible/ -p wa -k TA0002_T1072_Ansible
# -w /etc/ansible/ansible.cfg -p wa -k TA0002_T1072_Ansible
# -w /etc/ansible/hosts -p wa -k TA0002_T1072_Ansible
# -w /etc/ansible/group_vars/ -p wa -k TA0002_T1072_Ansible
# -w /etc/ansible/host_vars/ -p wa -k TA0002_T1072_Ansible

# Puppet Monitoring
# -a always,exit -F arch=b64 -S execve -F path=/opt/puppetlabs/bin/puppet -F key=TA0002_T1072_Puppet
-w /etc/puppetlabs/ -p wa -k TA0002_T1072_Puppet
# -w /etc/puppetlabs/puppet/puppet.conf -p wa -k TA0002_T1072_Puppet
# -w /etc/puppetlabs/code/ -p wa -k TA0002_T1072_Puppet
-w /var/lib/puppet/ -p wa -k TA0002_T1072_Puppet

# Chef Monitoring
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chef-client -F key=TA0002_T1072_Chef
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chef-solo -F key=TA0002_T1072_Chef
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/chef-apply -F key=TA0002_T1072_Chef
-w /etc/chef/ -p wa -k TA0002_T1072_Chef
# -w /etc/chef/client.rb -p wa -k TA0002_T1072_Chef
-w /var/chef/ -p wa -k TA0002_T1072_Chef

# SaltStack Monitoring
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/salt -F key=TA0002_T1072_SaltStack
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/salt-call -F key=TA0002_T1072_SaltStack
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/salt-master -F key=TA0002_T1072_SaltStack
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/salt-minion -F key=TA0002_T1072_SaltStack
-w /etc/salt/ -p wa -k TA0002_T1072_SaltStack
# -w /etc/salt/master -p wa -k TA0002_T1072_SaltStack
# -w /etc/salt/minion -p wa -k TA0002_T1072_SaltStack
-w /srv/salt/ -p wa -k TA0002_T1072_SaltStack

# Terraform (Infrastructure as Code)
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/terraform -F key=TA0002_T1072_Terraform
-a always,exit -F arch=b64 -S execve -F path=/usr/local/bin/terraform -F key=TA0002_T1072_Terraform
-w /*.tf -p wa -k TA0002_T1072_Terraform
-w /var/lib/terraform/ -p wa -k TA0002_T1072_Terraform


#//////////////////////////////////////////////////////////////////////////////////////////////////////
# TA0003 Persistence
#//////////////////////////////////////////////////////////////////////////////////////////////////////

#///////////////////////////////////////////////////
# T1098 - Account Manipulation
#///////////////////////////////////////////////////

# Monitor changes to user and group accounts
-w /etc/passwd -p wa -k TA0003_T1098_AccountManipulation
-w /etc/shadow -p wa -k TA0003_T1098_AccountManipulation
-w /etc/group -p wa -k TA0003_T1098_AccountManipulation

#///////////////////////////////////////////////////
# T1547 - Boot or Logon Autostart Execution
#///////////////////////////////////////////////////

# Monitor execution of startup services and scripts
-w /etc/rc.d/ -p wa -k TA0003_T1547_BootLogonAutostart
-w /etc/init.d/ -p wa -k TA0003_T1547_BootLogonAutostart
-w /etc/systemd/system/ -p wa -k TA0003_T1547_BootLogonAutostart

#///////////////////////////////////////////////////
# T1037 - Boot or Logon Initialization Scripts
#///////////////////////////////////////////////////

# Monitor execution of login scripts
-w /etc/profile.d/ -p wa -k TA0003_T1037_BootLogonInitScripts
-w /etc/profile -p wa -k TA0003_T1037_BootLogonInitScripts
# -w ~/.bashrc -p wa -k TA0003_T1037_BootLogonInitScripts
# -w ~/.bash_profile -p wa -k TA0003_T1037_BootLogonInitScripts

#///////////////////////////////////////////////////
# T1543 - Create or Modify System Process
#///////////////////////////////////////////////////

# Monitor creation and modification of system processes
-w /etc/systemd/system/ -p wa -k TA0003_T1543_ModifySystemProcess
-w /usr/lib/systemd/system/ -p wa -k TA0003_T1543_ModifySystemProcess

#///////////////////////////////////////////////////
# T1546 - Event Triggered Execution
#///////////////////////////////////////////////////

# Monitor modifications to execution trigger points
-w /etc/bash.bashrc -p wa -k TA0003_T1546_EventTriggeredExecution
# -w ~/.bashrc -p wa -k TA0003_T1546_EventTriggeredExecution
-w /etc/profile -p wa -k TA0003_T1546_EventTriggeredExecution
-w /etc/udev/rules.d/ -p wa -k TA0003_T1546_EventTriggeredExecution

#///////////////////////////////////////////////////
# T1053 - Scheduled Task/Job
#///////////////////////////////////////////////////

# Monitor modifications to scheduled tasks and timers
-w /etc/crontab -p wa -k TA0003_T1053_ScheduledTask
-w /etc/cron.d/ -p wa -k TA0003_T1053_ScheduledTask
-w /etc/cron.daily/ -p wa -k TA0003_T1053_ScheduledTask
-w /etc/cron.weekly/ -p wa -k TA0003_T1053_ScheduledTask
-w /etc/cron.hourly/ -p wa -k TA0003_T1053_ScheduledTask
-w /etc/cron.monthly/ -p wa -k TA0003_T1053_ScheduledTask
-w /etc/systemd/system/*.timer -p wa -k TA0003_T1053_ScheduledTask

#///////////////////////////////////////////////////
# T1133 - External Remote Services
#///////////////////////////////////////////////////

# Monitor modifications to remote access services
-w /etc/ssh/sshd_config -p wa -k TA0003_T1133_ExternalRemoteServices
-w /etc/openvpn/ -p wa -k TA0003_T1133_ExternalRemoteServices

#///////////////////////////////////////////////////
# T1574 - Hijack Execution Flow
#///////////////////////////////////////////////////

# Monitor execution flow hijacking attempts
-w /etc/ld.so.preload -p wa -k TA0003_T1574_HijackExecutionFlow
-w /etc/environment -p wa -k TA0003_T1574_HijackExecutionFlow
-w /etc/ld.so.conf -p wa -k TA0003_T1574_HijackExecutionFlow

#///////////////////////////////////////////////////
# T1525 - Implant Internal Image
#///////////////////////////////////////////////////

# Monitor modification of internal container images
-w /var/lib/containers/ -p wa -k TA0003_T1525_ImplantInternalImage

#///////////////////////////////////////////////////
# T1556 - Modify Authentication Process
#///////////////////////////////////////////////////

# Monitor modifications to authentication modules
-w /etc/pam.d/ -p wa -k TA0003_T1556_ModifyAuthenticationProcess

#///////////////////////////////////////////////////
# T1205 - Traffic Signaling
#///////////////////////////////////////////////////

# Monitor modifications to port knocking configurations
-w /etc/knockd.conf -p wa -k TA0003_T1205_TrafficSignaling

#///////////////////////////////////////////////////
# T1078 - Valid Accounts
#///////////////////////////////////////////////////

# Monitor changes to local accounts
-w /etc/passwd -p wa -k TA0003_T1078_ValidAccounts
-w /etc/shadow -p wa -k TA0003_T1078_ValidAccounts
-w /etc/group -p wa -k TA0003_T1078_ValidAccounts

#///////////////////////////////////////////////////
# T1542 - Pre-OS Boot
#///////////////////////////////////////////////////

# Monitor changes to EFI firmware variables
# -w /sys/firmware/efi/efivars/ -p wa -k TA0003_T1542_PreOSBoot

#///////////////////////////////////////////////////
# T1653 - Power Settings
#///////////////////////////////////////////////////

# Monitor modifications to power management settings
-w /etc/systemd/sleep.conf -p wa -k TA0003_T1653_PowerSettings
-w /etc/systemd/logind.conf -p wa -k TA0003_T1653_PowerSettings

#///////////////////////////////////////////////////
# T1137 - Office Application Startup
#///////////////////////////////////////////////////

# Monitor modifications to office startup settings
# -w ~/.config/libreoffice/ -p wa -k TA0003_T1137_OfficeApplicationStartup

#///////////////////////////////////////////////////
# T1505 - Server Software Component
#///////////////////////////////////////////////////

# Monitor modifications to server-side web components
-w /var/www/html/ -p wa -k TA0003_T1505_ServerSoftwareComponent
-w /etc/httpd/ -p wa -k TA0003_T1505_ServerSoftwareComponent

#///////////////////////////////////////////////////
# T1543 - Container Service
#///////////////////////////////////////////////////

# Monitor changes to container services
-w /etc/containers/ -p wa -k TA0003_T1543_ContainerService
-w /etc/docker/ -p wa -k TA0003_T1543_ContainerService


#//////////////////////////////////////////////////////////////////////////////////////////////////////
# TA0004 Privilege Escalation
#//////////////////////////////////////////////////////////////////////////////////////////////////////

#///////////////////////////////////////////////////
# T1548 - Abuse Elevation Control Mechanism
#///////////////////////////////////////////////////

# Monitor execution of privileged commands via sudo
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/sudo -F key=TA0004_T1548_sudo
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/sudo -F key=TA0004_T1548_sudo

# Monitor modifications to sudoers file
-w /etc/sudoers -p wa -k TA0004_T1548_sudoers
-w /etc/sudoers.d/ -p wa -k TA0004_T1548_sudoers

# Monitor setuid and setgid file executions
-a always,exit -F arch=b64 -S execve -F key=TA0004_T1548_setuid
-a always,exit -F arch=b32 -S execve -F key=TA0004_T1548_setuid
-w /usr/bin/su -p wa -k TA0004_T1548_su

#///////////////////////////////////////////////////
# T1055 - Process Injection
#///////////////////////////////////////////////////

# Monitor ptrace usage for process manipulation
-a always,exit -F arch=b64 -S ptrace -F key=TA0004_T1055_ptrace
-a always,exit -F arch=b32 -S ptrace -F key=TA0004_T1055_ptrace

# Monitor VDSO hijacking attempts
-w /proc/self/maps -p wa -k TA0004_T1055_vdso
-w /proc/self/mem -p wa -k TA0004_T1055_vdso

#///////////////////////////////////////////////////
# T1078 - Valid Accounts
#///////////////////////////////////////////////////

# Monitor creation or modification of local user accounts
-w /etc/passwd -p wa -k TA0004_T1078_local_accounts
-w /etc/shadow -p wa -k TA0004_T1078_local_accounts
-w /etc/group -p wa -k TA0004_T1078_local_accounts

#///////////////////////////////////////////////////
# T1037 - Boot or Logon Initialization Scripts
#///////////////////////////////////////////////////

# Monitor modifications to RC startup scripts
-w /etc/rc.local -p wa -k TA0004_T1037_rc_scripts
-w /etc/rc.d/ -p wa -k TA0004_T1037_rc_scripts

#///////////////////////////////////////////////////
# T1543 - Create or Modify System Process
#///////////////////////////////////////////////////

# Monitor systemd service modifications
-w /etc/systemd/system/ -p wa -k TA0004_T1543_systemd
-w /usr/lib/systemd/system/ -p wa -k TA0004_T1543_systemd

# Monitor container service modifications
-w /etc/containers/ -p wa -k TA0004_T1543_containers
-w /etc/docker/ -p wa -k TA0004_T1543_containers

#///////////////////////////////////////////////////
# T1546 - Event Triggered Execution
#///////////////////////////////////////////////////

# Monitor modifications to shell startup files
# -w ~/.bashrc -p wa -k TA0004_T1546_shell_config
# -w ~/.bash_profile -p wa -k TA0004_T1546_shell_config
-w /etc/bash.bashrc -p wa -k TA0004_T1546_shell_config
-w /etc/profile -p wa -k TA0004_T1546_shell_config

# Monitor trap command usage
-a always,exit -F arch=b64 -S execve -F path=/usr/bin/trap -F key=TA0004_T1546_trap
-a always,exit -F arch=b32 -S execve -F path=/usr/bin/trap -F key=TA0004_T1546_trap

# Monitor modifications to udev rules
-w /etc/udev/rules.d/ -p wa -k TA0004_T1546_udev

#///////////////////////////////////////////////////
# T1136 - Create Account
#///////////////////////////////////////////////////

# Monitor creation of new local user accounts
-w /etc/passwd -p wa -k TA0004_T1136_local_account
-w /etc/shadow -p wa -k TA0004_T1136_local_account
-w /etc/group -p wa -k TA0004_T1136_local_account









